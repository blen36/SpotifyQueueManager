{% extends 'jukebox/base.html' %}

{% block content %}
<style>
    /* --- СТИЛИ ВИНИЛА И ИНТЕРФЕЙСА --- */
    .glass-panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
    }

    .vinyl-container {
        position: relative;
        display: inline-block;
        width: 200px;
        height: 200px;
    }

    .vinyl-disk {
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, #222 30%, #050505 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        z-index: 1;
    }

    .vinyl-cover {
        width: 85px;
        height: 85px;
        border-radius: 50%;
        object-fit: cover;
        z-index: 2;
        border: 3px solid #111;
        animation: spin 4s linear infinite;
        animation-play-state: paused;
    }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .is-playing-state .vinyl-cover { animation-play-state: running; }
    .is-playing-state .tonearm-visual { transform: rotate(-12deg); }

    .tonearm-visual {
        position: absolute;
        top: 0;
        right: 10px;
        width: 8px;
        height: 90px;
        background: linear-gradient(to bottom, #999, #444);
        border-radius: 4px;
        transform-origin: top center;
        transform: rotate(-40deg);
        transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
    }

    #actual-progress-bar {
        height: 100%;
        background-color: #1DB954;
        width: 0%;
        transition: width 2.1s linear;
    }

    .control-btn { transition: all 0.2s; }
    .control-btn:hover { transform: scale(1.1); color: #1DB954 !important; }

    /* --- СТИЛИ ДЛЯ ГОЛОСОВОГО АССИСТЕНТА --- */
    .pulse-animation {
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
</style>

<div class="row justify-content-center mt-4" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    <div class="col-md-6 col-lg-5 text-center">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-outline-danger btn-sm" hx-post="/leave-room/">
                <i class="bi bi-box-arrow-left"></i> Leave
            </button>

            <div class="text-center">
                <span class="text-secondary text-uppercase small ls-1">Room Code</span>
                <div class="d-flex align-items-center justify-content-center gap-2">
                    <h2 class="h4 fw-bold mb-0 text-white">{{ room.code }}</h2>
                    <button id="voice-btn" class="btn btn-outline-warning btn-sm rounded-circle shadow-sm"
                            style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;"
                            title="Голосовое управление">
                        <i class="bi bi-mic-fill" style="font-size: 0.9rem;"></i>
                    </button>
                </div>
            </div>

            {% if is_host %}
            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal"
                    hx-get="/api/get-room/?code={{ room.code }}" hx-target="#settings-form-content">
                <i class="bi bi-gear-fill"></i>
            </button>
            {% else %}
            <div style="width: 45px;"></div>
            {% endif %}
        </div>

        <div id="spotify-status" class="alert alert-warning text-center mb-4" style="display:none;"></div>

        <div class="glass-panel p-4 mb-3">
            <div id="main-vinyl-container" class="vinyl-container mb-4">
                <div class="vinyl-disk">
                    <img id="dynamic-vinyl-cover" src="" class="vinyl-cover" style="display:none;">
                    <div id="vinyl-placeholder" class="bg-dark rounded-circle" style="width:85px; height:85px; border:3px solid #111;"></div>
                </div>
                <div class="tonearm-visual"></div>
            </div>

            <div class="progress-section mb-4 px-3">
                <div class="d-flex justify-content-between text-secondary mb-1" style="font-size: 0.7rem;">
                    <span id="js-display-time">0:00</span>
                    <span id="js-display-duration">0:00</span>
                </div>
                <div class="progress bg-dark" style="height: 4px; overflow: hidden; border-radius: 2px;">
                    <div id="actual-progress-bar"></div>
                </div>
            </div>

            <div id="music-player"
                 hx-get="/api/current-song/"
                 hx-trigger="load, every 2s"
                 hx-swap="innerHTML"
                 hx-on::after-request="syncVinylState()">
                <div class="text-secondary p-5">Loading player…</div>
            </div>

            <button id="pills-queue-tab" class="btn btn-outline-light btn-sm w-100 mt-3" data-bs-toggle="modal" data-bs-target="#queueModal"
                    hx-get="/api/queue/" hx-target="#queue-content">
                <i class="bi bi-music-note-list"></i> Open Queue
            </button>
        </div>

        <div class="search-section text-start mt-4">
            <h4 class="text-white mb-3 h5">Add Song to Queue</h4>
            <div class="input-group mb-3">
                <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-search"></i></span>
                <input type="text" name="query" class="form-control bg-dark text-white border-secondary"
                       placeholder="Search tracks..." hx-get="/api/spotify/search/" hx-trigger="keyup changed delay:500ms"
                       hx-target="#search-results" autocomplete="off">
            </div>
            <div id="search-results" style="max-height: 350px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="queueModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Queue</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="queue-content" class="modal-body"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Room Settings</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settings-form">
                    <div id="settings-form-content"></div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button class="btn btn-primary btn-sm" hx-patch="/update-room/" hx-include="#settings-form"
                        hx-vals='{"code": "{{ room.code }}"}' data-bs-dismiss="modal">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. ФУНКЦИЯ ОБНОВЛЕНИЯ ВИНИЛА ---
    function syncVinylState() {
        const dataTag = document.getElementById('player-data');
        if (!dataTag) return;

        const isPlaying = dataTag.getAttribute('data-playing') === 'true';
        const newImg = dataTag.getAttribute('data-image');
        const progress = dataTag.getAttribute('data-progress');
        const timeStr = dataTag.getAttribute('data-time');
        const durationStr = dataTag.getAttribute('data-duration');

        const container = document.getElementById('main-vinyl-container');
        const cover = document.getElementById('dynamic-vinyl-cover');
        const progressBar = document.getElementById('actual-progress-bar');

        if (isPlaying) container.classList.add('is-playing-state');
        else container.classList.remove('is-playing-state');

        if (progressBar) {
            if (isPlaying) {
                progressBar.style.transition = "width 2.1s linear";
                progressBar.style.width = progress + "%";
            } else {
                progressBar.style.transition = "none";
                progressBar.style.width = progress + "%";
            }
        }

        document.getElementById('js-display-time').innerText = timeStr;
        document.getElementById('js-display-duration').innerText = durationStr;

        if (newImg && cover.src !== newImg) {
            cover.src = newImg;
            cover.style.display = 'block';
            document.getElementById('vinyl-placeholder').style.display = 'none';
        }
    }

    // --- 2. ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- 3. ЛОГИКА ГОЛОСОВОГО УПРАВЛЕНИЯ ---
    document.addEventListener("DOMContentLoaded", function () {

        // Проверка авторизации
        fetch("/api/is-authenticated/")
            .then(res => res.json())
            .then(data => {
                if (!data.status) {
                    document.getElementById("spotify-status").style.display = "block";
                    {% if not is_host %}
                    document.getElementById("spotify-status").innerHTML = '<p class="mb-0">Waiting for host to connect...</p>';
                    {% endif %}
                }
            });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const voiceBtn = document.getElementById('voice-btn');

        if (!SpeechRecognition) {
            if(voiceBtn) voiceBtn.style.display = 'none';
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU';
        recognition.continuous = false;
        recognition.interimResults = false;

        voiceBtn.onclick = () => {
            try {
                recognition.start();
            } catch (e) { console.error(e); }
        };

        recognition.onstart = () => {
            voiceBtn.classList.remove('btn-outline-warning');
            voiceBtn.classList.add('btn-danger', 'pulse-animation');
        };

        recognition.onend = () => {
            voiceBtn.classList.remove('btn-danger', 'pulse-animation');
            voiceBtn.classList.add('btn-outline-warning');
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase().trim();
            console.log("Распознано:", transcript);

            // КОМАНДЫ (Методы PUT заменены на POST)
            if (transcript.includes('плей') || transcript.includes('играй') || transcript.includes('включи')) {
                apiCall('/api/play-song/', 'POST');
            }
            else if (transcript.includes('пауза') || transcript.includes('стоп') || transcript.includes('тихо') || transcript.includes('стой')) {
                apiCall('/api/pause-song/', 'POST');
            }
            else if (transcript.includes('следующий') || transcript.includes('дальше') || transcript.includes('скип')) {
                apiCall('/api/skip-song/', 'POST');
            }
            else if (transcript.includes('выйти') || transcript.includes('выйди') || transcript.includes('выход') || transcript.includes('покинуть')) {
                const leaveBtn = document.querySelector('button[hx-post="/leave-room/"]');
                if(leaveBtn) leaveBtn.click();
            }
            else if (transcript.includes('очередь')) {
                const queueTab = document.getElementById('pills-queue-tab');
                if(queueTab) queueTab.click();
            }
            else if (transcript.startsWith('добавь') || transcript.startsWith('поставь')) {
                const songName = transcript.replace(/^(добавь|поставь)\s*/, '');
                if (songName.length > 1) searchAndAdd(songName);
            }
        };

        function apiCall(url, method) {
            const csrftoken = getCookie('csrftoken');
            fetch(url, {
                method: method,
                headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' }
            }).then(res => {
                console.log(`API Call ${url} Status: ${res.status}`);
                // После команды принудительно обновляем плеер через 500мс
                setTimeout(() => htmx.trigger('#music-player', 'load'), 500);
            });
        }

        function searchAndAdd(query) {
            fetch(`/api/spotify/search/?query=${encodeURIComponent(query)}`)
                .then(res => res.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const btn = doc.querySelector('button[hx-vals]');

                    if (btn) {
                        const data = JSON.parse(btn.getAttribute('hx-vals'));
                        const csrftoken = getCookie('csrftoken');
                        const formData = new FormData();
                        formData.append('uri', data.uri);
                        formData.append('title', data.title);
                        formData.append('artist', data.artist);
                        formData.append('image_url', data.image_url);

                        fetch('/api/add-to-queue/', {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrftoken },
                            body: formData
                        }).then(res => {
                            if(res.ok) alert(`✅ Добавлено: ${data.title}`);
                        });
                    } else {
                        alert(`Не нашел: "${query}"`);
                    }
                });
        }
    });
</script>
{% endblock %}