{% extends 'jukebox/base.html' %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-6 col-lg-5 text-center">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-outline-danger btn-sm"
                    hx-post="/leave-room"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                <i class="bi bi-box-arrow-left"></i> Leave
            </button>

            <div class="text-center">
                <span class="text-secondary text-uppercase small ls-1">Room Code</span>
                <h2 class="h4 fw-bold mb-0">{{ room.code }}</h2>
            </div>

            {% if is_host %}
            <button class="btn btn-outline-light btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#settingsModal"
                    hx-get="/api/get-room?code={{ room.code }}"
                    hx-target="#settings-form-content">
                <i class="bi bi-gear-fill"></i>
            </button>
            {% endif %}
        </div>

        <div id="spotify-status" class="alert alert-warning text-center mb-4" style="display:none;">
            <p class="mb-2 fw-bold">Host must connect Spotify to enable music control</p>
            <button id="connect-spotify-btn" class="btn btn-success btn-sm">
                <i class="bi bi-spotify"></i> Connect Spotify
            </button>
        </div>

        <div id="spotify-features">
            <div id="music-player"
                 class="glass-panel p-4 mb-3"
                 hx-get="/api/current-song/"
                 hx-trigger="load, every 2s"
                 hx-swap="innerHTML">
                <div class="text-secondary">Loading player…</div>
            </div>

            <button class="btn btn-outline-light btn-sm w-100 mb-4"
                    data-bs-toggle="modal"
                    data-bs-target="#queueModal"
                    hx-get="/api/queue"
                    hx-target="#queue-content">
                <i class="bi bi-music-note-list"></i> Open Queue
            </button>

            <hr class="border-secondary my-4">

            <div class="search-section text-start">
                <h4 class="text-white mb-3 h5">Add Song to Queue</h4>
                <div class="input-group mb-3">
                    <span class="input-group-text bg-dark border-secondary text-secondary">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text"
                           name="query"
                           class="form-control bg-dark text-white border-secondary"
                           placeholder="Search Spotify tracks..."
                           hx-get="/api/spotify/search"
                           hx-trigger="keyup changed delay:500ms"
                           hx-target="#search-results"
                           autocomplete="off">
                </div>
                <div id="search-results" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="queueModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Room Queue</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"
                 id="queue-content"
                 hx-get="/api/queue"
                 hx-trigger="every 5s, load"
                 hx-swap="innerHTML">
                <div class="text-center p-3 text-secondary">Loading queue...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Room Settings</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settings-form">
                    <div id="settings-form-content"></div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-primary"
                        hx-patch="/update-room"
                        hx-include="#settings-form"
                        hx-vals='{"code": "{{ room.code }}"}'
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        data-bs-dismiss="modal">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

{% if is_host %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const statusBlock = document.getElementById("spotify-status");
    const featuresBlock = document.getElementById("spotify-features");
    const connectBtn = document.getElementById("connect-spotify-btn");

    fetch("/api/is-authenticated")
        .then(res => res.json())
        .then(data => {
            if (!data.status) {
                statusBlock.style.display = "block";
                {% if not is_host %}
                // Меняем текст для гостя, чтобы он не искал кнопку
                statusBlock.innerHTML = '<p class="mb-0 fw-bold">Waiting for the host to connect Spotify...</p>';
                {% endif %}
            }
        });

    {% if is_host %}
    connectBtn?.addEventListener("click", () => {
        fetch("/api/get-auth-url")
            .then(r => r.json())
            .then(data => {
                if (data.url) window.location.href = data.url;
            });
    });
    {% endif %}
});
</script>
{% endif %}
{% endblock %}